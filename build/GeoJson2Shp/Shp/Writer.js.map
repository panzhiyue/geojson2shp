{"version":3,"file":"Writer.js","sources":["../../../src/GeoJson2Shp/Shp/Writer.js"],"sourcesContent":["﻿/**\r\n * @module GeoJson2Shp/Shp/Writer\r\n */\r\n\r\n/**\r\n * 写入器基类,一般用于继承,而不在程序中实例化\r\n * \r\n * shp文件流信息\r\n * -------------------------------------\r\n *          |-----------------------|  ^\r\n * 00h /   0| FileCode(9994)        |  |\r\n *          |-----------------------|  |\r\n * 01h /   4|                       |  |\r\n *          |-----------------------|  |\r\n * 02h /  24| shp文件长度           |  |  \r\n *          |-----------------------|  |\r\n * 03h /  28| 版本号(1000)          |  |\r\n *          |-----------------------|  |\r\n * 04h /  32| 几何图形类型          |  |\r\n *          |-----------------------| 文件头信息\r\n * 05h /  36| x最小值               |  |\r\n *          |-----------------------|  |\r\n * 06h /  44| y最小值               |  |\r\n *          |-----------------------|  |\r\n * 07h /  52| x最大值               |  |\r\n *          |-----------------------|  |\r\n * 08h /  60| y最大值               |  |\r\n *          |-----------------------|  |\r\n * 09h /  68|                       |  |\r\n *          |                       |  |\r\n * 0Ah / 100|=======================|__v\r\n *          |                       |  ^\r\n *          |                       |  | \r\n *          |                       |  | \r\n *          | 几何图形信息          |  | \r\n *          |                       |  | \r\n *          |                       |  | \r\n *          |                       |  |\r\n *          |-----------------------|  v \r\n * -------------------------------------\r\n * \r\n * \r\n * shx文件流信息\r\n * -------------------------------------\r\n *          |-----------------------|  ^\r\n * 00h /   0| FileCode(9994)        |  |\r\n *          |-----------------------|  |\r\n * 01h /   4|                       |  |\r\n *          |-----------------------|  |\r\n * 02h /  24| shp文件长度           |  |\r\n *          |-----------------------|  |\r\n * 03h /  28| 版本号(1000)          |  |\r\n *          |-----------------------|  |\r\n * 04h /  32| 几何图形类型          |  |\r\n *          |-----------------------| 文件头信息\r\n * 05h /  36| x最小值               |  |\r\n *          |-----------------------|  |\r\n * 06h /  44| y最小值               |  |\r\n *          |-----------------------|  |\r\n * 07h /  52| x最大值               |  |\r\n *          |-----------------------|  |\r\n * 08h /  60| y最大值               |  |\r\n *          |-----------------------|  |\r\n * 09h /  68|                       |  |\r\n *          |                       |  |            \r\n * 0Ah / 100|=======================|__v              \r\n *          |                       |  ^       _    \r\n *          |                       |  |      /  |==============================================|  ^\r\n *          | ............          |  |_____/   | 00h /   0| 几何图形流在文件中的起始位置      |  |\r\n *          | 几何图形信息          |  |_____    |----------------------------------------------|  |\r\n *          | ............          |  |     \\   | 01h /   4| 几何图形流内容长度(不包括头信息)  |  |\r\n *          |                       |  |      \\_ |==============================================|  v\r\n *          |                       |  |\r\n *          |-----------------------|  v\r\n * -------------------------------------\r\n * \r\n */\r\nclass Writer {\r\n\r\n    /**\r\n     * 构造函数\r\n     * @param {Array.<module:GeoJson2Shp/Shp/Geometry~Geometry>} geometries 图形数组\r\n     * @param {module:GeoJson2Shp/Shp/GeometryType} type 图形类型\r\n     */\r\n    constructor(geometries, type) {\r\n        /**\r\n         * 图形数组\r\n         * @type {Array.<module:GeoJson2Shp/Shp/Geometry~Geometry>}\r\n        */\r\n        this.geometries_ = geometries;\r\n\r\n        /**\r\n         * 图形类型\r\n         * @type {module:GeoJson2Shp/Shp/GeometryType}\r\n         */\r\n        this.type_ = type;\r\n    }\r\n\r\n    /**\r\n     * 写入文件\r\n     * @param {function} callback 回调函数\r\n     */\r\n    write(callback) {\r\n\r\n        /**\r\n         * shp文件流长度 \r\n         */\r\n        var shpLength = 100 + this.getShpLength();\r\n        /**\r\n         * shx文件流长度 \r\n         */\r\n        var shxLength = 100 + this.getShxLength();\r\n\r\n        /**\r\n         * shp文件流 \r\n         */\r\n        var shpBuffer = new ArrayBuffer(shpLength);\r\n\r\n        /**\r\n         * shp文件视图 \r\n         */\r\n        var shpView = new DataView(shpBuffer);\r\n\r\n        /**\r\n         *  shx文件流\r\n         */\r\n        var shxBuffer = new ArrayBuffer(shxLength);\r\n\r\n        /**\r\n         * shx文件视图 \r\n         */\r\n        var shxView = new DataView(shxBuffer);\r\n\r\n        /**\r\n         * 范围 \r\n         */\r\n        var extent = this.getExtent();\r\n\r\n        // 写入shp文件头文件信息\r\n        this.writeHeader(shpView, this.type_);\r\n        // 写入shx文件头文件信息\r\n        this.writeHeader(shxView, this.type_);\r\n        //写入shp文件范围信息\r\n        this.writeExtent(extent, shpView);\r\n        //写入shx文件范围信息\r\n        this.writeExtent(extent, shxView);\r\n\r\n        //写入几何信息\r\n        this.writeGeometry(\r\n            new DataView(shpBuffer),\r\n            new DataView(shxBuffer));\r\n\r\n        //写入shp文件流长度\r\n        shpView.setInt32(24, shpLength / 2);\r\n        //写入shx文件流长度\r\n        shxView.setInt32(24, shxLength / 2);\r\n\r\n        callback(null, {\r\n            shp: shpView,\r\n            shx: shxView\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 写入文件头信息\r\n     * @param {DataView} view 视图\r\n     */\r\n    writeHeader(view) {\r\n        view.setInt32(0, 9994);\r\n        view.setInt32(28, 1000, true);\r\n        view.setInt32(32, this.type_, true);\r\n    }\r\n\r\n    /**\r\n     * 写入范围信息\r\n     * @param {module:GeoJson2Shp/Shp/Extent~Extent} extent  范围\r\n     * @param {DataView} view 视图\r\n     */\r\n    writeExtent(extent, view) {\r\n        view.setFloat64(36, extent.xmin, true);\r\n        view.setFloat64(44, extent.ymin, true);\r\n        view.setFloat64(52, extent.xmax, true);\r\n        view.setFloat64(60, extent.ymax, true);\r\n    }\r\n\r\n    /**\r\n     * 写入几何图形部分\r\n     * @param {any} shpView\r\n     * @param {any} shxView\r\n     */\r\n    writeGeometry(shpView, shxView) {\r\n\r\n    }\r\n\r\n    /**\r\n     * 获取shp文件长度\r\n     * @return {number} shp文件长度\r\n     */\r\n    getShpLength() {\r\n\r\n    }\r\n\r\n    /**\r\n     * 获取shx文件长度\r\n     * @return {number} shx文件长度\r\n     */\r\n    getShxLength() {\r\n\r\n    }\r\n    /**\r\n     * 获取范围\r\n     * @return {module:GeoJson2Sho/Shp/Extent~Extent} 范围\r\n     */\r\n    getExtent() {\r\n\r\n    }\r\n\r\n    /**\r\n     * 获取子图形数量 \r\n     * @param {any} geometries\r\n     * @return {number} 子图形数量\r\n     */\r\n    getPartCount(geometries) {\r\n    }\r\n\r\n    /**\r\n     * 获取平面坐标 \r\n     * @return {Array.<module:GeoJson2Shp/Shp/Geometry~Coordinate>} 平面坐标\r\n     */\r\n    getFlattened(coords, l) {\r\n        if (l === undefined) l = [];\r\n        if (typeof coords[0][0] == 'object') {\r\n            return coords.reduce(function (memo, c) {\r\n                return memo.concat(this.getFlattened(c));\r\n            }.bind(this), l);\r\n        } else {\r\n            return coords;\r\n        }\r\n    }\r\n}\r\n\r\nexport default Writer;\r\n"],"names":[],"mappings":"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"}