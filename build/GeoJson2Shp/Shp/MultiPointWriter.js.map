{"version":3,"file":"MultiPointWriter.js","sources":["../../../src/GeoJson2Shp/Shp/MultiPointWriter.js"],"sourcesContent":["﻿/**\r\n * @module GeoJson2Shp/Shp/MultiPointWriter\r\n */\r\nimport * as ext from './Extent.js'\r\nimport Writer from './Writer.js'\r\n\r\n\r\n/**\r\n * 多点写入器 \r\n * \r\n * shp文件点内容\r\n * ---------------------------------------\r\n *             |=======================|  ^\r\n * 00h /      0| 记录号(表示第几个图斑)|  |\r\n *             | 从1开始               |  |\r\n *             |-----------------------|头信息\r\n * 01h /      4| 内容所占长度          |  |\r\n *             |=======================|--v\r\n * 02h /      8| 几何图形类型          |  ^\r\n *             |-----------------------|  |\r\n * 03h /     12| x最小值               |  |\r\n *             |-----------------------|  |\r\n * 04h /     20| y最小值               |  |\r\n *             |-----------------------|  |\r\n * 05h /     28| x最大值               |  |\r\n *             |-----------------------|  |\r\n * 06h /     36| y最大值               | 内容\r\n *             |-----------------------|  |\r\n * 07h /     44| 坐标点数量            |  |\r\n *             |-----------------------|  |\r\n * 08h /       | ................      |  |\r\n * 48+         | 坐标点                |  |\r\n * partIndex*4+| ................      |  |\r\n * coorIndex*16|                       |  |\r\n *             |-----------------------|  v\r\n * ----------------------------------------\r\n */\r\nclass MultiPointWriter extends Writer {\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    constructor(geometries, type) {\r\n        super(geometries, type);\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    writeGeometry(shpView, shxView) {\r\n\r\n        /**\r\n         * 1个图形内容所占长度\r\n         * (1)几何类型(4)\r\n         * (2)范围(4*8=32)\r\n         * (4)坐标数量(4)\r\n         * (6)坐标点(coorCount*16)\r\n         * @type {number}\r\n         */\r\n        var contentLength;\r\n\r\n        /**\r\n         * 1个图形头信息所占长度\r\n         * (1)记录号(4)\r\n         * (2)内容所占长度(4)\r\n         * @type {number}\r\n         */\r\n        var headerLength = 8;\r\n\r\n        /**\r\n         * 几何图形信息在shp文件流中起始位置\r\n         * @type {number}\r\n         */\r\n        var shpI = 100;\r\n\r\n        /**\r\n         * 几何图形信息在shx文件流中起始位置\r\n         * @type {number}\r\n         */\r\n        var shxI = 100;\r\n\r\n        //循环写入几何图形\r\n        this.geometries_.forEach(\r\n            function writeMultiPoint(coordinates, i) {\r\n                //平面坐标\r\n                var flattened = this.getFlattened(coordinates);\r\n                //内容所占长度\r\n                //几何类型(4)+范围(4*8=32)+坐标数量(4)+坐标点(coorCount*16)\r\n                contentLength = 4 + 32 + 4 + (flattened.length * 16);\r\n\r\n                //范围\r\n                var featureExtent = flattened.reduce(function (extent, c) {\r\n                    return ext.extendCoordinate(extent, c);\r\n                }, ext.createEmpty());\r\n\r\n                //#region shx文件\r\n                //shx写入几何图形在shp文件起始位值(4)\r\n                shxView.setInt32(shxI, shpI / 2);\r\n                //shx写入记录内容长度(4)\r\n                shxView.setInt32(shxI + 4, contentLength / 2);\r\n                //shx文件下一个图形写入位置:记录位移量(4)+记录长度(4)=8\r\n                shxI += 8;\r\n                //#endregion shx文件\r\n\r\n                //#region shx文件\r\n                //shp写入记录号,从1开始(4)\r\n                shpView.setInt32(shpI, i + 1);\r\n                //shp写入内容长度(4)\r\n                shpView.setInt32(shpI + 4, contentLength / 2);\r\n                //shp写入几何图形类型(4)\r\n                shpView.setInt32(shpI + 8, this.type_, true);\r\n                //shp写入范围(32)\r\n                shpView.setFloat64(shpI + 12, featureExtent.xmin, true);\r\n                shpView.setFloat64(shpI + 20, featureExtent.ymin, true);\r\n                shpView.setFloat64(shpI + 28, featureExtent.xmax, true);\r\n                shpView.setFloat64(shpI + 36, featureExtent.ymax, true);\r\n                //shp写入坐标数量(4)\r\n                shpView.setInt32(shpI + 44, flattened.length, true);\r\n                //shp写入坐标(coorCount*16)\r\n                flattened.forEach(function writeLine(coords, i) {\r\n                    shpView.setFloat64(shpI + 48 + (i * 16), coords[0], true); // X\r\n                    shpView.setFloat64(shpI + 48 + (i * 16) + 8, coords[1], true); // Y\r\n                });\r\n                //shp文件下一个图形写入起始位置\r\n                shpI += contentLength + headerLength;\r\n                //#endregion shx文件\r\n            }.bind(this));\r\n    }\r\n\r\n    /** \r\n     * @inheritdoc\r\n     */\r\n    getPartCount(geometries) {\r\n        return geometries.length;\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    getExtent() {\r\n        return this.getFlattened(this.geometries_).reduce(function (extent, c) {\r\n            return ext.extendCoordinate(extent, c);\r\n        }, ext.createEmpty());\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc \r\n     */\r\n    getShxLength() {\r\n        return this.geometries_.length * 8;\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc \r\n     */\r\n    getShpLength() {\r\n        return (this.geometries_.length * 48) +\r\n            // points\r\n            (this.getFlattened(this.geometries_).length * 16);\r\n    }\r\n}\r\n\r\nexport default MultiPointWriter;\r\n"],"names":["super"],"mappings":"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"}