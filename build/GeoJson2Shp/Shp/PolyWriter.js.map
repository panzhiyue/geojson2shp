{"version":3,"file":"PolyWriter.js","sources":["../../../src/GeoJson2Shp/Shp/PolyWriter.js"],"sourcesContent":["﻿/**\r\n * @module GeoJson2Shp/Shp/PolyWriter\r\n */\r\n\r\nimport * as ext from './Extent.js'\r\nimport Writer from './Writer.js'\r\n\r\n/**\r\n * 线,面写入器 \r\n * \r\n * shp文件点内容\r\n * ---------------------------------------\r\n *             |=======================|  ^\r\n * 00h /      0| 记录号(表示第几个图斑)|  |\r\n *             | 从1开始               |  |\r\n *             |-----------------------|头信息\r\n * 01h /      4| 内容所占长度          |  |\r\n *             |=======================|--v\r\n * 02h /      8| 几何图形类型          |  ^\r\n *             |-----------------------|  |\r\n * 03h /     12| x最小值               |  |\r\n *             |-----------------------|  |\r\n * 04h /     20| y最小值               |  |\r\n *             |-----------------------|  |\r\n * 05h /     28| x最大值               |  |\r\n *             |-----------------------|  |\r\n * 06h /     36| y最大值               |  |\r\n *             |-----------------------|  |\r\n * 07h /     44| 子图形数量            |  |\r\n *             |-----------------------|内容\r\n * 08h /     48| 坐标点数量            |  |\r\n *             |-----------------------|  |\r\n *             | ................      |  |\r\n * 09h /       | 子图形起始坐标索引    |  |\r\n * 52+         | 从0开始               |  |\r\n * partIndex*4 | ................      |  |\r\n *             |-----------------------|  |\r\n * 0Ah /       | ................      |  |\r\n * 52+         | 坐标点                |  |\r\n * partIndex*4+| ................      |  |\r\n * coorIndex*16|                       |  |\r\n *             |-----------------------|  v\r\n * ----------------------------------------\r\n */\r\nclass PolyWriter extends Writer {\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    constructor(geometries, type) {\r\n        super(geometries, type);\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    writeGeometry(shpView, shxView) {\r\n\r\n        /**\r\n         * 1个图形内容所占长度\r\n         * (1)几何类型(4)\r\n         * (2)范围(4*8=32)\r\n         * (3)子图形数量(4)\r\n         * (4)坐标数量(4)\r\n         * (5)子图形起始坐标索引(partCount*4)\r\n         * (6)坐标点(coorCount*16)\r\n         * @type {number}\r\n         */\r\n        var contentLength;\r\n\r\n        /**\r\n         * 1个图形头信息所占长度\r\n         * (1)记录号(4)\r\n         * (2)内容所占长度(4)\r\n         * @type {number}\r\n         */\r\n        var headerLength = 8;\r\n\r\n        /**\r\n         * 几何图形信息在shp文件流中起始位置\r\n         * @type {number}\r\n         */\r\n        var shpI = 100;\r\n\r\n        /**\r\n         * 几何图形信息在shx文件流中起始位置\r\n         * @type {number}\r\n         */\r\n        var shxI = 100;\r\n\r\n        //循环写入几何图形\r\n        this.geometries_.forEach(function writePolyLine(coordinates, i) {\r\n            //平面坐标\r\n            var flattened = this.getFlattened(coordinates);\r\n            //子图形数量\r\n            var noParts = this.getPartCount([coordinates], this.type_);\r\n            //内容所占长度\r\n            //几何类型(4)+范围(4*8=32)+子图形数量(4)+坐标数量(4)+子图形起始坐标索引(partCount*4)+坐标点(coorCount*16)\r\n            contentLength = 4 + 32 + 4 + 4 + (noParts) * 4 + (flattened.length * 16);\r\n            //范围\r\n            var featureExtent = flattened.reduce(function (extent, c) {\r\n                return ext.extendCoordinate(extent, c);\r\n            }, ext.createEmpty());\r\n\r\n            //#region shx文件\r\n            //shx写入几何图形在shp文件起始位值(4)\r\n            shxView.setInt32(shxI, shpI / 2);\r\n            //shx写入记录内容长度(4)\r\n            shxView.setInt32(shxI + 4, contentLength / 2);\r\n            //shx文件下一个图形写入位置:记录位移量(4)+记录长度(4)=8\r\n            shxI += 8;\r\n            //#endregion shx文件\r\n\r\n\r\n            //#region shx文件\r\n            //shp写入记录号,从1开始(4)\r\n            shpView.setInt32(shpI, i + 1);\r\n            //shp写入内容长度(4)\r\n            shpView.setInt32(shpI + 4, contentLength / 2);\r\n            //shp写入几何图形类型(4)\r\n            shpView.setInt32(shpI + 8, this.type_, true);\r\n            //shp写入范围(32)\r\n            shpView.setFloat64(shpI + 12, featureExtent.xmin, true);\r\n            shpView.setFloat64(shpI + 20, featureExtent.ymin, true);\r\n            shpView.setFloat64(shpI + 28, featureExtent.xmax, true);\r\n            shpView.setFloat64(shpI + 36, featureExtent.ymax, true);\r\n            //shp写入子图形数量(4)\r\n            shpView.setInt32(shpI + 44, noParts, true);\r\n            //shp写入坐标数量(4)\r\n            shpView.setInt32(shpI + 48, flattened.length, true);\r\n\r\n            //#region 写入子图形坐标开始索引号(partCount*4)\r\n            //shp第一个子图形坐标开始索引号(4)\r\n            shpView.setInt32(shpI + 52, 0, true);\r\n\r\n            //shp写入子图形坐标开始索引号((partCount-1)*4)\r\n            var onlyParts = coordinates.reduce(function (arr, coords) {\r\n                if (Array.isArray(coords[0][0])) {\r\n                    arr = arr.concat(coords);\r\n                } else {\r\n                    arr.push(coords);\r\n                }\r\n                return arr;\r\n            }, []);\r\n            for (var p = 1; p < noParts; p++) {\r\n                shpView.setInt32( // set part index\r\n                    shpI + 52 + (p * 4),\r\n                    onlyParts.reduce(function (a, b, idx) {\r\n                        return idx < p ? a + b.length : a;\r\n                    }, 0),\r\n                    true\r\n                );\r\n            }\r\n            //#endregion 写入子图形坐标开始索引号\r\n\r\n            //shp写入坐标(coorCount*16)\r\n            flattened.forEach(function writeLine(coords, i) {\r\n                shpView.setFloat64(shpI + 56 + (i * 16) + (noParts - 1) * 4, coords[0], true); // X\r\n                shpView.setFloat64(shpI + 56 + (i * 16) + (noParts - 1) * 4 + 8, coords[1], true); // Y\r\n            });\r\n\r\n            //shp文件下一个图形写入起始位置\r\n            shpI += contentLength + headerLength;\r\n            //#endregion shx文件\r\n        }.bind(this));\r\n\r\n\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc \r\n     */\r\n    getPartCount(geometries) {\r\n        var no = 1;\r\n        no = geometries.reduce(function (no, coords) {\r\n            no += coords.length;\r\n            if (Array.isArray(coords[0][0][0])) { // multi\r\n                no += coords.reduce(function (no, rings) {\r\n                    return no + rings.length - 1; // minus outer\r\n                }, 0);\r\n            }\r\n            return no;\r\n        }, 0);\r\n        return no;\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    getExtent() {\r\n        return this.getFlattened(this.geometries_).reduce(function (extent, c) {\r\n            return ext.extendCoordinate(extent, c);\r\n        }, ext.createEmpty());\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    getShpLength() {\r\n        return (this.geometries_.length * 52) + this.getPartCount(this.geometries_) * 4 +\r\n            // points\r\n            (this.getFlattened(this.geometries_).length * 16);\r\n    }\r\n\r\n    /**\r\n     * @inheritdoc\r\n     */\r\n    getShxLength() {\r\n        return this.geometries_.length * 8;\r\n    }\r\n}\r\n\r\nexport default PolyWriter;\r\n"],"names":["super"],"mappings":"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"}